#!/bin/bash

set -o errexit

# Add chmod aliases
chmodf() { find $2 -type f -exec chmod -v $1 {} \;
}
chmodd() { find $2 -type d -exec chmod -v $1 {} \;
}

# If DataDirectory, identity keys or anonrc is mounted here,
# ownership needs to be changed to the TOR_USER user
chown -Rv ${TOR_USER}:${TOR_USER} /var/lib/tor

# Fix permissions
chmodd 700 /var/lib/tor
chmodf 600 /var/lib/tor

if [ ! -e /tor-config-done ]; then
    # Run this only once
    touch /tor-config-done

    if [ ! -f /etc/tor/anonrc ]; then
        cp /etc/anonrc /etc/tor/

        # Add Address from env variable
        echo "Setting Contact Email: ${IP_ADDRESS}"
        echo -e "\nAddress ${IP_ADDRESS}" >> /etc/tor/anonrc

        # Add Nickname from env variable
        echo "Setting chosen Nickname: ${TOR_NICKNAME}"
        echo -e "\nNickname ${TOR_NICKNAME}" >> /etc/tor/anonrc

        # Add ContactInfo from env variable
        echo "Setting Contact Email: ${CONTACT_EMAIL}"
        echo -e "\nContactInfo ${CONTACT_EMAIL}" >> /etc/tor/anonrc
    fi

    # Generate keys
    KEYPATH=/var/lib/tor/keys
    if [ ! -f ${KEYPATH}/authority_identity_key ]; then
        mkdir -p ${KEYPATH}
        echo "password" | tor-gencert --create-identity-key \
            -i ${KEYPATH}/authority_identity_key \
            -s ${KEYPATH}/authority_signing_key \
            -c ${KEYPATH}/authority_certificate \
            --passphrase-fd 0
    fi
    
fi

# Display OS version, Tor version & anonrc in log
echo -e "Debian Version: \c" && cat /etc/debian_version
tor --version
cat /etc/tor/anonrc

# else default to run whatever the user wanted like "bash"
exec "$@"
